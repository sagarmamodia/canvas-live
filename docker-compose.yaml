services:
    mongodb:
      image: mongo
      container_name: whiteboard-mongodb
      ports:
        - "27017:27017"
    
    zookeeper:
      image: confluentinc/cp-zookeeper:latest
      hostname: zookeeper
      container_name: zookeeper
      ports:
        - "2181:2181" # Expose Zookeeper's client port
      environment:
        ZOOKEEPER_CLIENT_PORT: 2181
        ZOOKEEPER_TICK_TIME: 2000

    # 2. Kafka Broker Service
    kafka:
      image: confluentinc/cp-kafka:7.4.0
      hostname: kafka
      container_name: kafka
      depends_on:
        - zookeeper # Ensure Zookeeper starts before Kafka
      ports:
        # Expose port 9092 for external clients (host machine)
        - "9092:9092" 
      environment:
        KAFKA_BROKER_ID: 1
        # Connect Kafka to Zookeeper using the service name 'zookeeper'
        KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181 
        
        # Define listeners for internal and external communication
        # PLAINTEXT: Internal connection (used by other containers/services)
        # PLAINTEXT_HOST: External connection (used by your host machine)
        KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
        KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
        
        # CRITICAL: Advertised Listeners tell clients how to connect
        # Internal (docker network): kafka:29092

        # External (host machine): localhost:9092 (or host.docker.internal:9092 on Mac/Win)
        KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
        
        # Auto-create topics so you don't have to create them manually
        KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
        
        # Required replication factor setting for a single broker
        KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1

    kafka-ui:
      image: provectuslabs/kafka-ui:latest
      container_name: kafka-ui
      ports:
        - "8080:8080" # Access the UI on your host machine at http://localhost:8080
      depends_on:
        - kafka
      environment:
        # CRITICAL: This is the internal Docker network address for Kafka
        KAFKA_CLUSTERS_0_NAME: MyLocalKafkaCluster
        KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS: kafka:29092 # Use the internal Docker network address
        
        # Optional: Add Zookeeper host
        KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181 

    # 2. Redis Cache Service
    redis:
      image: redis:7-alpine # Use a small, stable image
      hostname: redis
      container_name: redis
      # Expose port 6379 only for host access (optional, but good for debugging)
      ports:
        - "6379:6379" 
      command: ["redis-server", "--appendonly", "yes"] # Enable persistence (AOF)
#       volumes:
#         - redis_data:/data # Volume to keep data persistent across restarts

# volumes:
#   redis_data: